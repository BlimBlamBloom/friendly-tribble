<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oruga de N√∫meros</title>
    <style>
       * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevents the 'shifted' scroll effect */
            background-color: #451a03; /* Matches your darkest mud color */
        }
        
        #game-container {
            width: 100vw;
            height: 100vh;
            position: fixed; /* Fixed is safer than relative for full-screen games */
            top: 0;
            left: 0;
        }

        .background-stones {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            pointer-events: none;
        }

        .stone {
            position: absolute;
            background: #44403c;
            border-radius: 4px;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        .title {
            font-size: 4rem;
            font-weight: bold;
            color: #fef3c7;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.8);
        }

        .subtitle {
            font-size: 1.5rem;
            color: #fef3c7;
            text-align: center;
        }

        .btn {
            padding: 1.5rem 3rem;
            font-size: 2rem;
            font-weight: bold;
            background: #fef3c7;
            color: #78350f;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .btn:hover {
            background: #fde68a;
            transform: scale(1.1);
        }

        .countdown {
            font-size: 8rem;
            font-weight: bold;
            color: #fef3c7;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5;  }
        }

        .score-display {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(68, 26, 3, 0.8);
            padding: 1rem 2rem;
            border-radius: 9999px;
            z-index: 20;
        }

        .score-text {
            color: #fef3c7;
            font-size: 2rem;
            font-weight: bold;
        }

        .caterpillar-head, .caterpillar-segment {
            position: absolute;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            transition: all 0.15s linear;
            z-index: 10;
        }

        .caterpillar-head {
            background: #166534;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .eye {
            width: 12px;
            height: 12px;
            background: black;
            border-radius: 50%;
            position: absolute;
            top: 16px;
        }

        .eye.left { left: 12px; }
        .eye.right { right: 12px; }

        .mouth {
            width: 24px;
            height: 4px;
            background: #14532d;
            border-radius: 9999px;
            position: absolute;
            bottom: 20px;
        }

        .antenna {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 15px;
            background: #14532d;
        }

        .antenna::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -2px;
            width: 6px;
            height: 6px;
            background: #14532d;
            border-radius: 50%;
        }

        .antenna.left { left: 18px; transform: rotate(-15deg); }
        .antenna.right { right: 18px; transform: rotate(15deg); }

        .caterpillar-segment {
            background: #15803d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .caterpillar-segment.target {
            background: #dc2626;
            animation: pulse 1s ease-in-out infinite;
            box-shadow: 0 0 0 4px #f87171;
        }

        .foot {
            position: absolute;
            bottom: -8px;
            width: 3px;
            height: 12px;
            background: #14532d;
            border-radius: 2px;
        }

        .foot.left { left: 18px; }
        .foot.right { right: 18px; }

        .stick-figure {
            position: absolute;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            animation: bounce 0.3s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        .input-container {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 24rem;
            max-width: 90vw;
            z-index: 20;
            display: flex;
            gap: 0.5rem;
        }

        .input-field {
            flex: 1;
            padding: 1rem 1.5rem;
            font-size: 1.5rem;
            border-radius: 0.5rem;
            background: #fef3c7;
            color: #78350f;
            border: none;
            font-weight: bold;
            outline: none;
        }

        .input-field:focus {
            box-shadow: 0 0 0 4px #fbbf24;
        }

        .submit-btn {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .submit-btn:hover {
            background: #15803d;
        }

        .emoji {
            font-size: 4rem;
            animation: bounce 0.5s ease-in-out infinite;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="background-stones" id="bg-stones"></div>

        <!-- Home Screen -->
        <div id="home-screen" class="screen">
            <h1 class="title">Oruga de N√∫meros</h1>
            <p class="subtitle">¬°Escribe los n√∫meros en espa√±ol para escapar!</p>
            <button class="btn" onclick="startGame()">EMPEZAR</button>
        </div>

        <!-- Countdown Screen -->
        <div id="countdown-screen" class="screen hidden">
            <div class="countdown" id="countdown-text">3</div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="score-display">
                <div class="score-text" id="score-text">15/15</div>
            </div>
            <div id="caterpillar-container"></div>
            <svg width="60" height="80" viewBox="0 0 60 80" class="stick-figure" id="stick-figure">
                <ellipse cx="30" cy="12" rx="12" ry="4" fill="#8B4513"/>
                <rect x="20" y="12" width="20" height="8" fill="#8B4513"/>
                <ellipse cx="30" cy="20" rx="8" ry="3" fill="#654321"/>
                <circle cx="30" cy="28" r="8" fill="#f4a460" stroke="#333" stroke-width="1"/>
                <circle cx="27" cy="27" r="1.5" fill="#000"/>
                <circle cx="33" cy="27" r="1.5" fill="#000"/>
                <path d="M 26 30 Q 30 32 34 30" stroke="#333" stroke-width="1" fill="none"/>
                <line x1="30" y1="36" x2="30" y2="55" stroke="#333" stroke-width="2"/>
                <line x1="30" y1="40" x2="20" y2="35" stroke="#333" stroke-width="2"/>
                <line x1="30" y1="40" x2="40" y2="48" stroke="#333" stroke-width="2"/>
                <line x1="30" y1="55" x2="22" y2="70" stroke="#333" stroke-width="2"/>
                <line x1="30" y1="55" x2="38" y2="65" stroke="#333" stroke-width="2"/>
            </svg>
            <div class="input-container">
                <input type="text" id="input-field" class="input-field" placeholder="Escribe en espa√±ol..." autocomplete="off">
                <button class="submit-btn" onclick="submitAnswer()">‚úì</button>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div id="level-complete-screen" class="screen hidden">
            <div class="emoji">üéâ</div>
            <h2 class="title" id="level-complete-title">¬°Nivel 1 Completo!</h2>
            <button class="btn" onclick="nextLevel()">Siguiente Nivel</button>
        </div>

        <!-- Game Over Screen -->
        <div id="gameover-screen" class="screen hidden">
            <div class="emoji">üò±</div>
            <h2 class="title">¬°Atrapado!</h2>
            <p class="subtitle">¬°La oruga te atrap√≥!</p>
            <button class="btn" onclick="startGame()">Intentar de Nuevo</button>
        </div>

        <!-- Win Screen -->
        <div id="win-screen" class="screen hidden">
            <div class="emoji">üèÜ</div>
            <h2 class="title">¬°Escapaste!</h2>
            <p class="subtitle">¬°Completaste los 4 niveles!</p>
            <button class="btn" onclick="startGame()">Jugar de Nuevo</button>
        </div>
    </div>

    <script>
        const GRID_COLS = 15; 
        const MAX_COL = GRID_COLS - 1;
        
        const levelConfig = {
            1: { max: 9, target: 15 },
            2: { max: 20, target: 20 },
            3: { max: 30, target: 30 },
            4: { max: 100, target: 50 }
        };

        const spanishNumbers = {
            0: 'cero', 1: 'uno', 2: 'dos', 3: 'tres', 4: 'cuatro',
            5: 'cinco', 6: 'seis', 7: 'siete', 8: 'ocho', 9: 'nueve',
            10: 'diez', 11: 'once', 12: 'doce', 13: 'trece', 14: 'catorce',
            15: 'quince', 16: 'dieciseis', 17: 'diecisiete', 18: 'dieciocho', 19: 'diecinueve',
            20: 'veinte', 21: 'veintiuno', 22: 'veintidos', 23: 'veintitres', 24: 'veinticuatro',
            25: 'veinticinco', 26: 'veintiseis', 27: 'veintisiete', 28: 'veintiocho', 29: 'veintinueve',
            30: 'treinta', 31: 'treinta y uno', 32: 'treinta y dos', 33: 'treinta y tres', 34: 'treinta y cuatro',
            35: 'treinta y cinco', 36: 'treinta y seis', 37: 'treinta y siete', 38: 'treinta y ocho', 39: 'treinta y nueve',
            40: 'cuarenta', 41: 'cuarenta y uno', 42: 'cuarenta y dos', 43: 'cuarenta y tres', 44: 'cuarenta y cuatro',
            45: 'cuarenta y cinco', 46: 'cuarenta y seis', 47: 'cuarenta y siete', 48: 'cuarenta y ocho', 49: 'cuarenta y nueve',
            50: 'cincuenta', 51: 'cincuenta y uno', 52: 'cincuenta y dos', 53: 'cincuenta y tres', 54: 'cincuenta y cuatro',
            55: 'cincuenta y cinco', 56: 'cincuenta y seis', 57: 'cincuenta y siete', 58: 'cincuenta y ocho', 59: 'cincuenta y nueve',
            60: 'sesenta', 61: 'sesenta y uno', 62: 'sesenta y dos', 63: 'sesenta y tres', 64: 'sesenta y cuatro',
            65: 'sesenta y cinco', 66: 'sesenta y seis', 67: 'sesenta y siete', 68: 'sesenta y ocho', 69: 'sesenta y nueve',
            70: 'setenta', 71: 'setenta y uno', 72: 'setenta y dos', 73: 'setenta y tres', 74: 'setenta y cuatro',
            75: 'setenta y cinco', 76: 'setenta y seis', 77: 'setenta y siete', 78: 'setenta y ocho', 79: 'setenta y nueve',
            80: 'ochenta', 81: 'ochenta y uno', 82: 'ochenta y dos', 83: 'ochenta y tres', 84: 'ochenta y cuatro',
            85: 'ochenta y cinco', 86: 'ochenta y seis', 87: 'ochenta y siete', 88: 'ochenta y ocho', 89: 'ochenta y nueve',
            90: 'noventa', 91: 'noventa y uno', 92: 'noventa y dos', 93: 'noventa y tres', 94: 'noventa y cuatro',
            95: 'noventa y cinco', 96: 'noventa y seis', 97: 'noventa y siete', 98: 'noventa y ocho', 99: 'noventa y nueve',
            100: 'cien'
        };

        let gameState = 'home';
        let level = 1;
        let score = 0;
        let caterpillar = [];
        let positions = [];
        let direction = 1;
        let currentRow = 0;
        let currentCol = 0;
        let gameInterval = null;
        let headElement = null;

        function normalizeSpanish(text) {
            return text.toLowerCase()
                .replace(/√°/g, 'a')
                .replace(/√©/g, 'e')
                .replace(/√≠/g, 'i')
                .replace(/√≥/g, 'o')
                .replace(/√∫/g, 'u')
                .trim();
        }

        function generateCaterpillar() {
            const config = levelConfig[level];
            caterpillar = [];
            for (let i = 0; i < config.target; i++) {
                caterpillar.push(Math.floor(Math.random() * (config.max + 1)));
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function startGame() {
            level = 1;
            score = 0;
            startLevel();
        }

        function startLevel() {
            currentRow = 0;
            currentCol = 0;
            direction = 1;
            positions = [];
            
            showScreen('countdown-screen');
            let count = 3;
            document.getElementById('countdown-text').textContent = count;
            
            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    document.getElementById('countdown-text').textContent = count;
                } else {
                    clearInterval(countInterval);
                    startPlaying();
                }
            }, 1000);
        }

        function startPlaying() {
            generateCaterpillar();
            gameState = 'playing';
            
            showScreen('game-screen');
            document.getElementById('game-screen').classList.remove('hidden');
            
            updateScore();
            document.getElementById('input-field').value = '';
            document.getElementById('input-field').focus();
            
            createHead();
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 800);
        }

        function createHead() {
            const container = document.getElementById('caterpillar-container');
            container.innerHTML = '';
            
            headElement = document.createElement('div');
            headElement.className = 'caterpillar-head';
            headElement.innerHTML = `
                <div class="antenna left"></div>
                <div class="antenna right"></div>
                <div class="eye left"></div>
                <div class="eye right"></div>
                <div class="mouth"></div>
            `;
            container.appendChild(headElement);
        }

        function gameLoop() {
            if (gameState !== 'playing') return;
            
            // Add current position to history BEFORE moving
            positions.unshift({ row: currentRow, col: currentCol });
            if (positions.length > caterpillar.length) {
                positions = positions.slice(0, caterpillar.length);
            }
            
            let newCol = currentCol + direction;
            let newRow = currentRow;
            let newDir = direction;
            
            if (newCol > MAX_COL) {
                newCol = MAX_COL;
                newRow += 1;
                newDir = -1;
                
                if (newRow >= 10) {
                    endGame('gameover');
                    return;
                }
            } else if (newCol < 0) {
                newCol = 0;
                newRow += 1;
                newDir = 1;
                
                if (newRow >= 10) {
                    endGame('gameover');
                    return;
                }
            }
            
            currentCol = newCol;
            currentRow = newRow;
            direction = newDir;
            
            renderCaterpillar();
        }

        function renderCaterpillar() {
                // Calculate how wide one "unit" is based on current screen size
                const unitWidth = window.innerWidth / GRID_COLS;
                
                // This 'topBuffer' fixes the "shifted up" bug by pushing Row 0 down
                const topBuffer = 80; 
            
                if (headElement) {
                    // We use unitWidth to place the head exactly in its 1/15th slot
                    headElement.style.left = `${currentCol * unitWidth + (unitWidth / 2)}px`;
                    headElement.style.top = `${currentRow * unitWidth + topBuffer}px`;
                    
                    // Keep the head scaling/rotation logic
                    headElement.style.transform = direction === -1 
                        ? 'translate(-50%, -50%) scaleX(-1)' 
                        : 'translate(-50%, -50%)';
                        
                    // Make the head size match the grid size
                    headElement.style.width = `${unitWidth * 0.9}px`;
                    headElement.style.height = `${unitWidth * 0.9}px`;
                }
                
                const container = document.getElementById('caterpillar-container');
                const segments = container.querySelectorAll('.caterpillar-segment');
                segments.forEach(s => s.remove());
                
                positions.forEach((pos, idx) => {
                    if (idx >= caterpillar.length) return;
                    
                    const segment = document.createElement('div');
                    segment.className = 'caterpillar-segment';
                    if (idx === 0) segment.classList.add('target');
                    
                    segment.innerHTML = `
                        ${caterpillar[idx]}
                        <div class="foot left"></div>
                        <div class="foot right"></div>
                    `;
            
                    // Apply the same unitWidth math and topBuffer to the body
                    segment.style.left = `${pos.col * unitWidth + (unitWidth / 2)}px`;
                    segment.style.top = `${pos.row * unitWidth + topBuffer}px`;
                    segment.style.transform = 'translate(-50%, -50%)';
                    
                    // Make body segments match the responsive size
                    segment.style.width = `${unitWidth * 0.9}px`;
                    segment.style.height = `${unitWidth * 0.9}px`;
                    
                    container.appendChild(segment);
                });
            }

        function submitAnswer() {
            if (caterpillar.length === 0 || positions.length === 0) return;
            
            const input = document.getElementById('input-field').value;
            const currentNumber = caterpillar[0];
            const correctAnswer = normalizeSpanish(spanishNumbers[currentNumber]);
            const userAnswer = normalizeSpanish(input);
            
            if (userAnswer === correctAnswer) {
                score++;
                
                // 1. Remove the first number (the one you just typed)
                caterpillar.shift();
                
                // 2. Remove the LAST position (the tail) instead of the first
                // This keeps the head from jumping backward.
                positions.pop();
                
                // Note: We removed the "currentCol = positions[0].col" lines 
                // so the head maintains its current path.
                
                updateScore();
                
                const target = levelConfig[level].target;
                if (score >= target) {
                    if (level === 4) {
                        endGame('win');
                    } else {
                        endGame('levelComplete');
                    }
                } else {
                    renderCaterpillar();
                }
            }
            
            document.getElementById('input-field').value = '';
            document.getElementById('input-field').focus();
        }

        function updateScore() {
            const total = levelConfig[level].target;
            document.getElementById('score-text').textContent = `${caterpillar.length}/${total}`;
        }

        function endGame(type) {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            gameState = type;
            
            if (type === 'gameover') {
                showScreen('gameover-screen');
            } else if (type === 'win') {
                showScreen('win-screen');
            } else if (type === 'levelComplete') {
                document.getElementById('level-complete-title').textContent = `¬°Nivel ${level} Completo!`;
                showScreen('level-complete-screen');
            }
        }

        function nextLevel() {
            level++;
            score = 0;
            startLevel();
        }

        document.getElementById('input-field').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAnswer();
        });

        // Generate background stones
        const bgStones = document.getElementById('bg-stones');
        for (let i = 0; i < 30; i++) {
            const stone = document.createElement('div');
            stone.className = 'stone';
            stone.style.width = '48px';
            stone.style.height = '48px';
            stone.style.left = `${Math.random() * 100}%`;
            stone.style.top = `${Math.random() * 100}%`;
            stone.style.transform = `rotate(${Math.random() * 45}deg)`;
            bgStones.appendChild(stone);
        }
    </script>
</body>
</html>
