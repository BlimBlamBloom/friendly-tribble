import React, { useState, useEffect, useRef } from 'react';

const CaterpillarEscape = () => {
  const [gameState, setGameState] = useState('home');
  const [level, setLevel] = useState(1);
  const [score, setScore] = useState(0);
  const [input, setInput] = useState('');
  const [caterpillar, setCaterpillar] = useState([]);
  const [positions, setPositions] = useState([]); // Track all segment positions
  const [direction, setDirection] = useState(1); // 1 for right, -1 for left
  const [currentRow, setCurrentRow] = useState(0);
  const [currentCol, setCurrentCol] = useState(0);
  const inputRef = useRef(null);

  const SEGMENT_SIZE = 70;
  const SCREEN_WIDTH = typeof window !== 'undefined' ? window.innerWidth : 1200;
  const MAX_COL = Math.floor(SCREEN_WIDTH / SEGMENT_SIZE) - 1;

  const levelConfig = {
    1: { max: 9, target: 15 },
    2: { max: 20, target: 20 },
    3: { max: 30, target: 30 },
    4: { max: 100, target: 50 }
  };

  const spanishNumbers = {
    0: 'cero', 1: 'uno', 2: 'dos', 3: 'tres', 4: 'cuatro',
    5: 'cinco', 6: 'seis', 7: 'siete', 8: 'ocho', 9: 'nueve',
    10: 'diez', 11: 'once', 12: 'doce', 13: 'trece', 14: 'catorce',
    15: 'quince', 16: 'dieciseis', 17: 'diecisiete', 18: 'dieciocho', 19: 'diecinueve',
    20: 'veinte', 21: 'veintiuno', 22: 'veintidos', 23: 'veintitres', 24: 'veinticuatro',
    25: 'veinticinco', 26: 'veintiseis', 27: 'veintisiete', 28: 'veintiocho', 29: 'veintinueve',
    30: 'treinta', 31: 'treinta y uno', 32: 'treinta y dos', 33: 'treinta y tres', 34: 'treinta y cuatro',
    35: 'treinta y cinco', 36: 'treinta y seis', 37: 'treinta y siete', 38: 'treinta y ocho', 39: 'treinta y nueve',
    40: 'cuarenta', 41: 'cuarenta y uno', 42: 'cuarenta y dos', 43: 'cuarenta y tres', 44: 'cuarenta y cuatro',
    45: 'cuarenta y cinco', 46: 'cuarenta y seis', 47: 'cuarenta y siete', 48: 'cuarenta y ocho', 49: 'cuarenta y nueve',
    50: 'cincuenta', 51: 'cincuenta y uno', 52: 'cincuenta y dos', 53: 'cincuenta y tres', 54: 'cincuenta y cuatro',
    55: 'cincuenta y cinco', 56: 'cincuenta y seis', 57: 'cincuenta y siete', 58: 'cincuenta y ocho', 59: 'cincuenta y nueve',
    60: 'sesenta', 61: 'sesenta y uno', 62: 'sesenta y dos', 63: 'sesenta y tres', 64: 'sesenta y cuatro',
    65: 'sesenta y cinco', 66: 'sesenta y seis', 67: 'sesenta y siete', 68: 'sesenta y ocho', 69: 'sesenta y nueve',
    70: 'setenta', 71: 'setenta y uno', 72: 'setenta y dos', 73: 'setenta y tres', 74: 'setenta y cuatro',
    75: 'setenta y cinco', 76: 'setenta y seis', 77: 'setenta y siete', 78: 'setenta y ocho', 79: 'setenta y nueve',
    80: 'ochenta', 81: 'ochenta y uno', 82: 'ochenta y dos', 83: 'ochenta y tres', 84: 'ochenta y cuatro',
    85: 'ochenta y cinco', 86: 'ochenta y seis', 87: 'ochenta y siete', 88: 'ochenta y ocho', 89: 'ochenta y nueve',
    90: 'noventa', 91: 'noventa y uno', 92: 'noventa y dos', 93: 'noventa y tres', 94: 'noventa y cuatro',
    95: 'noventa y cinco', 96: 'noventa y seis', 97: 'noventa y siete', 98: 'noventa y ocho', 99: 'noventa y nueve',
    100: 'cien'
  };

  const normalizeSpanish = (text) => {
    return text.toLowerCase()
      .replace(/Ã¡/g, 'a')
      .replace(/Ã©/g, 'e')
      .replace(/Ã­/g, 'i')
      .replace(/Ã³/g, 'o')
      .replace(/Ãº/g, 'u')
      .trim();
  };

  const generateFullCaterpillar = () => {
    const config = levelConfig[level];
    const segments = [];
    for (let i = 0; i < config.target; i++) {
      segments.push(Math.floor(Math.random() * (config.max + 1)));
    }
    setCaterpillar(segments);
  };

  const startGame = () => {
    setGameState('countdown');
    setScore(0);
    setLevel(1);
    setCurrentRow(0);
    setCurrentCol(0);
    setDirection(1);
    setPositions([]);
  };

  const startLevel = () => {
    setGameState('countdown');
    setCurrentRow(0);
    setCurrentCol(0);
    setDirection(1);
    setPositions([]);
  };

  const [countdown, setCountdown] = useState(3);

  useEffect(() => {
    if (gameState === 'countdown') {
      if (countdown > 0) {
        const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
        return () => clearTimeout(timer);
      } else {
        setGameState('playing');
        generateFullCaterpillar();
        if (inputRef.current) inputRef.current.focus();
      }
    } else if (gameState === 'levelComplete' || gameState === 'home') {
      setCountdown(3);
    }
  }, [gameState, countdown]);

  useEffect(() => {
    if (gameState === 'playing') {
      const timer = setInterval(() => {
        setPositions(prev => {
          const newPositions = [{ row: currentRow, col: currentCol }, ...prev];
          // Keep only as many positions as we have segments
          return newPositions.slice(0, caterpillar.length);
        });

        // Move head to next position
        let newCol = currentCol;
        let newRow = currentRow;
        let newDir = direction;

        newCol += direction;

        // Check boundaries
        if (newCol > MAX_COL) {
          // Hit right boundary
          newCol = MAX_COL;
          newRow += 1;
          newDir = -1;
          
          if (newRow >= 10) {
            setGameState('gameOver');
            return;
          }
        } else if (newCol < 0) {
          // Hit left boundary
          newCol = 0;
          newRow += 1;
          newDir = 1;
          
          if (newRow >= 10) {
            setGameState('gameOver');
            return;
          }
        }

        setCurrentCol(newCol);
        setCurrentRow(newRow);
        setDirection(newDir);
      }, 800);
      
      return () => clearInterval(timer);
    }
  }, [gameState, currentCol, currentRow, direction, MAX_COL, caterpillar.length]);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (caterpillar.length === 0 || positions.length === 0) return;

    // The target is the first segment in the body (index 0)
    const currentNumber = caterpillar[0];
    const correctAnswer = normalizeSpanish(spanishNumbers[currentNumber]);
    const userAnswer = normalizeSpanish(input);

    if (userAnswer === correctAnswer) {
      const newScore = score + 1;
      setScore(newScore);
      
      // Remove the first segment
      const newCaterpillar = caterpillar.slice(1);
      setCaterpillar(newCaterpillar);
      
      // Remove the first position
      setPositions(prev => prev.slice(1));

      const target = levelConfig[level].target;
      if (newScore >= target) {
        if (level === 4) {
          setGameState('won');
        } else {
          setGameState('levelComplete');
        }
      }
    }
    
    setInput('');
  };

  const nextLevel = () => {
    setLevel(level + 1);
    setScore(0);
    startLevel();
  };

  const StickFigure = () => (
    <svg width="60" height="80" viewBox="0 0 60 80" className="animate-bounce" style={{ animationDuration: '0.3s' }}>
      <ellipse cx="30" cy="12" rx="12" ry="4" fill="#8B4513"/>
      <rect x="20" y="12" width="20" height="8" fill="#8B4513"/>
      <ellipse cx="30" cy="20" rx="8" ry="3" fill="#654321"/>
      <circle cx="30" cy="28" r="8" fill="#f4a460" stroke="#333" strokeWidth="1"/>
      <circle cx="27" cy="27" r="1.5" fill="#000"/>
      <circle cx="33" cy="27" r="1.5" fill="#000"/>
      <path d="M 26 30 Q 30 32 34 30" stroke="#333" strokeWidth="1" fill="none"/>
      <line x1="30" y1="36" x2="30" y2="55" stroke="#333" strokeWidth="2"/>
      <line x1="30" y1="40" x2="20" y2="35" stroke="#333" strokeWidth="2"/>
      <line x1="30" y1="40" x2="40" y2="48" stroke="#333" strokeWidth="2"/>
      <line x1="30" y1="55" x2="22" y2="70" stroke="#333" strokeWidth="2"/>
      <line x1="30" y1="55" x2="38" y2="65" stroke="#333" strokeWidth="2"/>
    </svg>
  );

  if (gameState === 'home') {
    return (
      <div className="relative w-full h-screen bg-gradient-to-b from-amber-900 via-amber-800 to-amber-950 overflow-hidden">
        <div className="absolute inset-0 opacity-20">
          {[...Array(20)].map((_, i) => (
            <div key={i} className="absolute w-16 h-16 bg-stone-800 rounded-lg" 
                 style={{ 
                   left: `${Math.random() * 100}%`, 
                   top: `${Math.random() * 100}%`,
                   transform: `rotate(${Math.random() * 45}deg)`
                 }} />
          ))}
        </div>

        <div className="absolute animate-bounce" 
             style={{ 
               animation: 'float 8s infinite linear',
               left: '20%',
               top: '30%'
             }}>
          <div className="w-12 h-12 rounded-full bg-green-700 flex items-center justify-center">
            <div className="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center">
              <div className="w-3 h-3 bg-black rounded-full mr-1"></div>
              <div className="w-3 h-3 bg-black rounded-full"></div>
            </div>
          </div>
        </div>

        <div className="absolute animate-pulse" 
             style={{ 
               animation: 'run 6s infinite linear',
               left: '50%',
               top: '50%'
             }}>
          <StickFigure />
        </div>

        <div className="relative z-10 flex flex-col items-center justify-center h-full gap-8">
          <h1 className="text-7xl font-bold text-amber-200 text-center drop-shadow-lg" 
              style={{ textShadow: '4px 4px 8px rgba(0,0,0,0.8)' }}>
            Oruga de NÃºmeros
          </h1>
          <p className="text-2xl text-amber-100 text-center">Â¡Escribe los nÃºmeros en espaÃ±ol para escapar!</p>
          <button 
            onClick={startGame}
            className="px-12 py-6 text-3xl font-bold text-amber-900 bg-amber-200 rounded-lg hover:bg-amber-300 transition-all transform hover:scale-110 shadow-2xl">
            EMPEZAR
          </button>
        </div>

        <style>{`
          @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(100px, 100px) rotate(90deg); }
            50% { transform: translate(200px, 50px) rotate(180deg); }
            75% { transform: translate(100px, -50px) rotate(270deg); }
          }
          @keyframes run {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(300px, -100px); }
          }
        `}</style>
      </div>
    );
  }

  if (gameState === 'countdown') {
    return (
      <div className="w-full h-screen bg-gradient-to-b from-amber-900 via-amber-800 to-amber-950 flex items-center justify-center">
        <div className="text-9xl font-bold text-amber-200 animate-pulse">
          {countdown}
        </div>
      </div>
    );
  }

  if (gameState === 'levelComplete') {
    return (
      <div className="w-full h-screen bg-gradient-to-b from-amber-900 via-amber-800 to-amber-950 flex flex-col items-center justify-center gap-8">
        <div className="text-7xl animate-bounce">ğŸ‰</div>
        <h2 className="text-6xl font-bold text-amber-200">Â¡Nivel {level} Completo!</h2>
        <div className="animate-ping">
          <StickFigure />
        </div>
        <button 
          onClick={nextLevel}
          className="px-12 py-6 text-3xl font-bold text-amber-900 bg-amber-200 rounded-lg hover:bg-amber-300 transition-all transform hover:scale-110 shadow-2xl">
          Siguiente Nivel
        </button>
      </div>
    );
  }

  if (gameState === 'gameOver') {
    return (
      <div className="w-full h-screen bg-gradient-to-b from-red-900 via-red-800 to-red-950 flex flex-col items-center justify-center gap-8">
        <div className="text-7xl">ğŸ˜±</div>
        <h2 className="text-6xl font-bold text-red-200">Â¡Atrapado!</h2>
        <p className="text-3xl text-red-100">Â¡La oruga te atrapÃ³!</p>
        <button 
          onClick={startGame}
          className="px-12 py-6 text-3xl font-bold text-red-900 bg-red-200 rounded-lg hover:bg-red-300 transition-all transform hover:scale-110 shadow-2xl">
          Intentar de Nuevo
        </button>
      </div>
    );
  }

  if (gameState === 'won') {
    return (
      <div className="w-full h-screen bg-gradient-to-b from-green-900 via-green-800 to-green-950 flex flex-col items-center justify-center gap-8">
        <div className="text-7xl animate-bounce">ğŸ†</div>
        <h2 className="text-6xl font-bold text-green-200">Â¡Escapaste!</h2>
        <p className="text-3xl text-green-100">Â¡Completaste los 4 niveles!</p>
        <button 
          onClick={startGame}
          className="px-12 py-6 text-3xl font-bold text-green-900 bg-green-200 rounded-lg hover:bg-green-300 transition-all transform hover:scale-110 shadow-2xl">
          Jugar de Nuevo
        </button>
      </div>
    );
  }

  const totalSegments = levelConfig[level].target;

  return (
    <div className="relative w-full h-screen bg-gradient-to-b from-amber-900 via-amber-800 to-amber-950 overflow-hidden">
      <div className="absolute inset-0 opacity-10">
        {[...Array(30)].map((_, i) => (
          <div key={i} className="absolute w-12 h-12 bg-stone-800 rounded" 
               style={{ 
                 left: `${Math.random() * 100}%`, 
                 top: `${Math.random() * 100}%`,
                 transform: `rotate(${Math.random() * 45}deg)`
               }} />
        ))}
      </div>

      <div className="absolute bottom-4 right-4 bg-amber-950 bg-opacity-80 px-8 py-4 rounded-full z-20">
        <div className="text-amber-200 text-3xl font-bold">{caterpillar.length}/{totalSegments}</div>
      </div>

      {/* Caterpillar head */}
      <div className="absolute transition-all duration-150 ease-linear z-10" 
           style={{ 
             left: `${currentCol * SEGMENT_SIZE + 35}px`,
             top: `${currentRow * SEGMENT_SIZE + 35}px`,
             transform: direction === -1 ? 'translate(-50%, -50%) scaleX(-1)' : 'translate(-50%, -50%)'
           }}>
        <div className="w-16 h-16 rounded-full bg-green-800 flex items-center justify-center relative"
             style={direction === -1 ? { transform: 'scaleX(-1)' } : {}}>
          <div className="w-3 h-3 bg-black rounded-full absolute left-3 top-4"></div>
          <div className="w-3 h-3 bg-black rounded-full absolute right-3 top-4"></div>
          <div className="w-6 h-1 bg-green-900 rounded-full absolute bottom-5"></div>
        </div>
      </div>

      {/* Body segments */}
      {positions.map((pos, idx) => {
        if (idx >= caterpillar.length) return null;
        const num = caterpillar[idx];
        const isTarget = idx === 0; // First body segment is the target
        return (
          <div key={idx} 
               className={`absolute w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white transition-all duration-150 z-10
                 ${isTarget ? 'bg-red-600 animate-pulse ring-4 ring-red-400' : 'bg-green-700'}`}
               style={{
                 left: `${pos.col * SEGMENT_SIZE + 35}px`,
                 top: `${pos.row * SEGMENT_SIZE + 35}px`,
                 transform: 'translate(-50%, -50%)'
               }}>
            {num}
          </div>
        );
      })}

      <div className="absolute bottom-32 left-1/2 transform -translate-x-1/2 z-10">
        <StickFigure />
      </div>

      <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-96 z-20">
        <div className="flex gap-2">
          <input
            ref={inputRef}
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => {
              if (e.key === 'Enter') {
                handleSubmit(e);
              }
            }}
            className="flex-1 px-6 py-4 text-2xl rounded-lg bg-amber-100 text-amber-900 font-bold focus:outline-none focus:ring-4 focus:ring-amber-400"
            placeholder="Escribe en espaÃ±ol..."
            autoComplete="off"
          />
          <button 
            onClick={handleSubmit}
            className="px-8 py-4 text-2xl font-bold bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            âœ“
          </button>
        </div>
      </div>
    </div>
  );
};

export default CaterpillarEscape;
